<!--
manager_homepage.html
Chart location: D. User stories involved: D, F, K
Form Input(s): none
JavaScript Function(s): viewEmployees(), getEmployeeData()
Backend Function(s):  getEmployees()
Possible Transfer(s): manager_detailView.html, manager_employeeView.html
Comment(s):
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manager Homepage</title>
</head>
    <style>
        p {
            margin: 0;
        }
        td {
            border: 1px solid;
        }
        th {
            border: 1px solid;
        }

    </style>
<body>
    <h1>Manager Homepage</h1>
    <p id="tableDescription">There exist the following employees at your workplace: </p>
    <table id="employeeTable" style="border:1px solid"></table>
    <br/>
    <form name="allReims" action="AllReims" method="post">
        <span>View requests from all employees</span><br>
        <label for="pendingChoice">Choose what requests to view</label>
        <select id="pendingChoice" name="pendingChoice">
            <option value="pending">Pending Reimbursements</option>
            <option value="resolved">Resolved Reimbursements</option>
        </select>
        <input type="submit">
    </form>
    <br/>
    <br/>
    <p>You can also view all of the reimbursement requests for a specific employee by entering their employee id and pressing Submit Query.</p>
    <input id="EmployeeIDField" type="text" placeholder="Employee ID"> <button id="Query" value="Query" onclick="getSINGLEEmployeeRequests()">Submit Query</button>
    <br/>
    <br/>
    <a href="logoutServlet">Logout</a>
</body>

<script>
    //This function (credit to https://stackoverflow.com/questions/26246601/wildcard-string-comparison-in-javascript),
    //implements the wildcard operator *.
    function matchRuleShort(str, rule) {
        let escapeRegex = (str) => str.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
        return new RegExp("^" + rule.split("*").map(escapeRegex).join(".*") + "$").test(str);
    }

    //--------------manager_homepage.html-----------------------------
    //If we're on the manager_homepage.html, then run its display functions.
    if(matchRuleShort(window.location.href, "*/manager_homepage.html")){
        getEmployeeRequests(document);
    }

    function getEmployeeRequests (document) {
        const xmlHttpRequest = new XMLHttpRequest();
        xmlHttpRequest.onreadystatechange = function () {
            if(this.readyState === 4 && this.status === 200){
                displayEmployeesTable(document, JSON.parse(this.responseText))
            }
        }
        xmlHttpRequest.open("POST", "GetAllEmployeesNEW");
        xmlHttpRequest.setRequestHeader("Content-type", "application/json");
        xmlHttpRequest.send();
    }

    function displayEmployeesTable(document, employees){
        let id;
        let tableHTML = "";
        tableHTML+="<tr><th>ID</th><th>First Name</th><th>Last Name</th><th>Street Address</th><th>Job Title</th><th>Username</th></tr>";
        for (let key=0, size=employees.length; key<size; key++){
            tableHTML+='<tr><td>';
            tableHTML+=employees[key].id;
            tableHTML+='</td><td>';
            tableHTML+=employees[key].fname;
            tableHTML+= '</td><td>';
            tableHTML+=employees[key].lname;
            tableHTML+= '</td><td>';
            tableHTML+=employees[key].address;
            tableHTML+='</td><td>';
            tableHTML+=employees[key].jobTitle;
            tableHTML+= '</td><td>';
            tableHTML+=employees[key].username;
            tableHTML+= '</td><tr>';
         }
        document.getElementById("employeeTable").innerHTML = tableHTML;
    }

    function getSINGLEEmployeeRequests () {
        let empID = parseInt(document.getElementById("EmployeeIDField").value);
        console.log("6");
        const xmlHttpRequest = new XMLHttpRequest();
        xmlHttpRequest.onreadystatechange = function () {
            if(this.readyState === 4 && this.status === 200){
                console.log(this.responseText);
                console.log(JSON.parse(this.responseText));
                viewSINGLEEmployeeRequests(JSON.parse(this.responseText))
            }
        }
        xmlHttpRequest.open("POST", "GetRReqByPersonID");
        xmlHttpRequest.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xmlHttpRequest.send("requestorID="+empID);
    }

    function viewSINGLEEmployeeRequests(singleEmployeeRequests){
        console.log(singleEmployeeRequests);
        const requests = singleEmployeeRequests;
        let tableHTML = "";
        tableHTML+="<tr><th>Is approved?</th><th>Requestor</th><th>Approver</th><th>Dollar Amount</th><th>Employee's Comment (optional)</th><th>ID</th></tr>";
        for (let key=0, size=requests.length; key<size; key++){
            tableHTML+='<tr><td>';
            tableHTML+=requests[key].approved;
            tableHTML+='</td><td>';
            tableHTML+=requests[key].requestor;
            tableHTML+= '</td><td>';
            tableHTML+=requests[key].approver;
            tableHTML+= '</td><td>';
            tableHTML+=requests[key].amount;
            tableHTML+='</td><td>';
            tableHTML+=requests[key].comment;
            tableHTML+= '</td><td>';
            tableHTML+=requests[key].id;
            tableHTML+= '</td></tr>';
        }
        document.getElementById("tableDescription").innerHTML = "That employee has made the following reimbursement requests.";
        document.getElementById("employeeTable").innerHTML = tableHTML;

    }



    const exApprovedRequests = {
        "requests":[
            {"approved":true, "requestor":"John Lock", "approver":"John Locka", "amount": 999.99, "comment":"I spent all of it on food.", "id":1},
            {"approved":true, "requestor":"John Locka", "approver":"John Lockb", "amount": 999.99, "comment":"I spent all of it on food.", "id":2},
            {"approved":true, "requestor":"John Lockb", "approver":"John Lockc", "amount": 999.99, "comment":"I spent all of it on food.", "id":3},
            {"approved":true, "requestor":"John Lockc", "approver":"John Lockd", "amount": 999.99, "comment":"I spent all of it on food.", "id":4},
            {"approved":true, "requestor":"John Lockd", "approver":"John Locke", "amount": 999.99, "comment":"I spent all of it on food.", "id":5},
            {"approved":true, "requestor":"John Locke", "approver":"Abe Lincoln", "amount": 999.99, "comment":"I spent all of it on food.", "id":6},
        ]};

    // function seeEmployeesRequests(employeeID){
    //     const xmlHttpRequest = new XMLHttpRequest();
    //     xmlHttpRequest.onreadystatechange = function () {
    //         if(this.readyState === 4 && this.status === 200){
    //             document.open();
    //             document.write(this.response);
    //             document.close();
    //         }
    //     }
    //     xmlHttpRequest.open("get", "manager_employeeView.html");
    //     xmlHttpRequest.send();
    // }
    //--------------manager_homepage.html-----------------------------
</script>
</html>