<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Purchase Ticket</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>
<body>
    <h1>Ticket Purchase</h1>
<!--    <form action="TicketServlet" method="post">-->
        <h3>Customer Details</h3>
        <input type="number" id="customerID" value="getCookie(user)" disabled>
<!--        <p>Please enter your credentials. If you are a newcomer to the system, purchasing a ticket will create a Customer profile for you!</p>-->
<!--        <label for="customerEmail">Email:</label>-->
<!--        <input id="customerEmail" type="text" name="customerEmail"/><br/>-->
<!--        <label for="customerPassword">Password:</label>-->
<!--        <input id="customerPassword" type="number" name="customerPassword"/><br/><br/>-->
        <h3>Ticket Details</h3>
        <label for="ticketAccessLevel">Access Level (Admission Tiers):</label>
        <select id="ticketAccessLevel" name="ticketAccessLevel">
            <option value="1">Basic - $15/day</option>
            <option value="2">VIP - $20/day</option>
            <option value="3">Super VIP - $30/day</option>
        </select><br/>
        <label for="ticketDays">Days:</label>
        <select id="ticketDays" name="ticketDays">
            <option value="1">1 Day</option>
            <option value="2">2 Days</option>
            <option value="3">3 Days</option>
            <option value="4">4 Days</option>
            <option value="5">5 Days</option>
            <option value="6">6 Days</option>
            <option value="7">1 Week</option>
        </select><br/>
        <h3>Family Pass</h3>
        <p>2x Price, good for up to 4. (Children under 2 get free admittance.)</p>
        <input type="radio" id="familyPassFalse" name="familyPass" value="1" onclick="calculateCost();">
        <label for="familyPassFalse">No</label><br/>
        <input type="radio" id="familyPassTrue" name="familyPass" value="2" onclick="calculateCost();">
        <label for="familyPassTrue">Yes</label><br/>
        <button id="submitTicket" type="submit">Submit</button>
<!--    </form>-->

    <div class="requestFormTotal">
        <p><b>Total:</b></p>
        <p id="total">$ --.--</p>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            document.querySelector('#submitTicket').addEventListener('click', (e) => {
                e.preventDefault();

                let customerIDinput = document.getElementById('customerID');
                //let customerID = customerIDinput.value;
                let customerID = 777;

                let ticketAccessLevelInput = document.getElementById('ticketAccessLevel');
                let accessLevel = ticketAccessLevelInput.value;

                let ticketDaysInput = document.getElementById('ticketDays');
                let ticketDays = ticketDaysInput.value;

                let startDateRaw = new Date();
                let endDateRaw = new Date();

                let startDate = "" + startDateRaw.getMonth() + "-" + startDateRaw.getDate() + "-" + startDateRaw.getFullYear() + " " + startDateRaw.getHours() + ":" + startDateRaw.getMinutes();
                let endDate = "" + endDateRaw.getMonth() + "-" + endDateRaw.getDate() + "-" + endDateRaw.getFullYear() + " " + endDateRaw.getHours() + ":" + endDateRaw.getMinutes();

                const reqBody = {customerID,accessLevel,startDate,endDate};
                console.log(reqBody);
                const xhr = new XMLHttpRequest();
                xhr.onreadystatechange = () => {
                    if(xhr.readyState === 4) {
                        if(xhr.status === 400) {
                            alert("Your request was invalid");
                        } else if(xhr.status === 200) {
                            const p = document.createElement('p');
                            p.innerHTML = JSON.parse(xhr.responseText).customerID + JSON.parse(xhr.responseText).accessLevel + JSON.parse(xhr.responseText).startDate + JSON.parse(xhr.responseText).endDate;
                            document.body.appendChild(p);
                        }
                    }
                };

                xhr.open("POST", "Coaster_customer/TicketServlet");
                xhr.setRequestHeader("Content-Type", "application/json");
                xhr.send(JSON.stringify(reqBody));
            });
        })

        function calculateCost() {
            var accessLevel = Number(document.getElementById("ticketAccessLevel").value);
            var accessLevelRate = 15 + (5*(accessLevel-1));
            var daysRate = Number(document.getElementById("ticketDays").value);

            // familyPassRate
            var familyPassRateOption = 1; // default
            if (document.getElementById('familyPassFalse').checked) {
                familyPassRateOption = document.getElementById('familyPassFalse').value;
            } else if (document.getElementById('familyPassTrue').checked) {
                familyPassRateOption = document.getElementById('familyPassTrue').value;
            }
            var familyPassRate = Number(familyPassRateOption);

            // Calculate total
            var subtotal_value = accessLevelRate * daysRate * familyPassRate;
            var total_value = subtotal_value * 1.06; // 6% tax

            // Convert total into string with decimal values shown
            var total_value_string = total_value.toFixed(2);

            // Retrieve paragraph containing total
            var total = document.getElementById("total");
            total.innerHTML = "$ " + total_value_string;
        }

        function getCookie(cname) {
            var name = cname + "=";
            var decodedCookie = decodeURIComponent(document.cookie);
            var ca = decodedCookie.split(';');
            for(var i = 0; i <ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
          return "";
        }

        calculateCost(); // Perform initial calculation with default values
    </script>
</body>
</html>