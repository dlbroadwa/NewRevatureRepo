<!--
index.html
Chart location: A. User stories covered: A, B 	
Form Input(s): "username", "password"
JavaScript Function(s): none
Backend Function(s): none
Possible Transfer(s): newUser.html, employee_homepage.html, manager_homepage.html
Comment(s):
-->

<!doctype html>
<html>
<head>
    <title>Expense Reimbursement System</title>
    <style>
        h2 {
            text-align: center;
            margin-left: 25%;
            margin-right: 25%;
            width : 340px;
        } 
        fieldset {
            margin-left: 25%;
            margin-right: 25%;
            width: 300px;
        }
        input {
            margin-right: 0px;
            float: right;
        }
    </style>
</head>
<body>
<div>
<h2>Expense Reimbursement System</h2>
    <fieldset> <legend>User Credentials</legend>
        <label>Username:
            <tab></tab>
            <input id="username" name="username" type="text"/>
        </label>
        <br/>
        <br/>
        <label>Password:
            <input id="password" name="password" type="password"/>
        </label>
        <br/>
        <br/>
        <input name="submit" type="button" value="Login" onclick="checkCredentials()">
        <br/>
        <p id="invalid"></p>
    </fieldset>

    <a href="newEmployee.html">New user?</a>

</div>
</body>

<script>
    const doc = this.document;
    let session = {"username" : "null", "password" : "null", "currentPage" : "index.html", "error" : "false"};

    //--------------shared-----------------------------
    //This function (credit to https://stackoverflow.com/questions/26246601/wildcard-string-comparison-in-javascript),
    //implements the wildcard operator *.
    function matchRuleShort(str, rule) {
        let escapeRegex = (str) => str.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
        return new RegExp("^" + rule.split("*").map(escapeRegex).join(".*") + "$").test(str);
    }

    function changePage(destinationPage){
        const xmlHttpRequest = new XMLHttpRequest();
        xmlHttpRequest.onreadystatechange = function () {
            if(this.readyState === 4 && this.status === 200){
                document.open();
                document.write(this.response);
                document.close();
            }
        }
        xmlHttpRequest.open("get", destinationPage);
        xmlHttpRequest.send();
    }

    //--------------index.html-----------------------------
    function checkCredentials(){
        session.username = doc.getElementById("username").value;
        session.password = doc.getElementById("password").value;
        const xmlHttpRequest = new XMLHttpRequest();
        xmlHttpRequest.onreadystatechange = function () {
            if(this.readyState === 4 && this.status === 200){
                let responseJSON = JSON.parse(this.responseText);
                session.currentPage = responseJSON[2];
                session.error = responseJSON[3];
                if(session.currentPage != "index.html"){
                    changePage(session.currentPage);
                } else {
                    document.getElementById("invalid").innerHTML = "Invalid User Credentials.";
                }
            }
        }
        xmlHttpRequest.open("POST", "loginServletNEW");
        xmlHttpRequest.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xmlHttpRequest.send("username="+session.username+"&password="+session.password);
    }

    //--------------manager_homepage.html-----------------------------
    //If we're on the manager_homepage.html, then run its display functions.
    if(matchRuleShort(window.location.href, "*/manager_homepage.html")){
        getEmployeeRequests(document);
    }

    function getEmployeeRequests (document) {
        const xmlHttpRequest = new XMLHttpRequest();
        xmlHttpRequest.onreadystatechange = function () {
            if(this.readyState === 4 && this.status === 200){
                displayEmployeesTable(document, JSON.parse(this.responseText))
            }
        }
        xmlHttpRequest.open("POST", "GetAllEmployeesNEW");
        xmlHttpRequest.setRequestHeader("Content-type", "application/json");
        xmlHttpRequest.send(JSON.stringify(session));
    }

    function displayEmployeesTable(document, employees){
        let tableHTML = "";
        tableHTML+="<tr><th>ID</th><th>First Name</th><th>Last Name</th><th>Street Address</th><th>Job Title</th><th>Username</th><th>See Employee's Requests</th></tr>";
        for (let key=0, size=employees.length; key<size; key++){
            tableHTML+='<tr><td>';
            tableHTML+=employees[key].id;
            tableHTML+='</td><td>';
            tableHTML+=employees[key].fname;
            tableHTML+= '</td><td>';
            tableHTML+=employees[key].lname;
            tableHTML+= '</td><td>';
            tableHTML+=employees[key].address;
            tableHTML+='</td><td>';
            tableHTML+=employees[key].jobTitle;
            tableHTML+= '</td><td>';
            tableHTML+=employees[key].username;
            tableHTML+= '</td><td>';
            tableHTML+="<Button onClick=changePageEmployeeRequests()>See Employee's Requests</Button>";
            tableHTML+= '</td></tr>';
        }
        document.getElementById("employeeTable").innerHTML = tableHTML;
    }

    function changePageEmployeeRequests(){
        const xmlHttpRequest = new XMLHttpRequest();
        xmlHttpRequest.onreadystatechange = function () {
            if(this.readyState === 4 && this.status === 200){
                document.open();
                document.write(this.response);
                document.close();
            }
        }
        xmlHttpRequest.open("get", "manager_employeeView.html");
        xmlHttpRequest.send();
    }



    const exData = {
        "employees":[
            {"id":1, "fname":"John", "lname":"Doe", "address":"23434 street", "jobTitle":"HelpDesk", "username":"usernameExample", "password":"passwordExample"},
            {"id":2, "fname":"Johna", "lname":"Doea", "address":"23434 streeta", "jobTitle":"HelpDesk", "username":"usernameExamplea", "password":"passwordExamplea"},
            {"id":3, "fname":"Johnb", "lname":"Doeb", "address":"23434 streetb", "jobTitle":"HelpDesk", "username":"usernameExampleb", "password":"passwordExampleb"},
            {"id":4, "fname":"Johnc", "lname":"Doec", "address":"23434 streetc", "jobTitle":"HelpDesk", "username":"usernameExamplec", "password":"passwordExamplec"},
            {"id":5, "fname":"Johnd", "lname":"Doed", "address":"23434 streetd", "jobTitle":"HelpDesk", "username":"usernameExampled", "password":"passwordExampled"},
            {"id":6, "fname":"Johne", "lname":"Doee", "address":"23434 streete", "jobTitle":"HelpDesk", "username":"usernameExamplee", "password":"passwordExamplee"},
        ]};
    //--------------manager_homepage.html-----------------------------
</script>
</html>